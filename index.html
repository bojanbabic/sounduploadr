<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ajaxFileUpload</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="/static/javascript/jquery.js"></script>
<script src="/static/javascript/jquery.uploadProgress.js"></script>
<script type="text/javascript">
interval = null;

function openProgressBar() {
        /* generate random progress-id */
        uuid = "";
        for (i = 0; i < 32; i++) {
                uuid += Math.floor(Math.random() * 16).toString(16);
        }
        /* patch the form-action tag to include the progress-id */
        document.getElementById("upload").action="/uload?X-Progress-ID=" + uuid;

        /* call the progress-updater every 1000ms */
        interval = window.setInterval( function () {  fetch(uuid);  }, 1000 );
}

function fetch(uuid) {
        req = new XMLHttpRequest();
        var bar_updated = false;
        req.open("GET", "/progress", 1);
        req.setRequestHeader("X-Progress-ID", uuid);
        req.onreadystatechange = function () {
                if (req.readyState == 4) {
                        if (req.status == 200) {
                                /* poor-man JSON parser */
                                //var upload = eval(req.responseText);
                                var upload = JSON.parse(req.responseText);

                                document.getElementById('response').innerHTML = upload.state;

                                /* change the width if the inner progress-bar */
                                if (upload.state == 'done' || upload.state == 'uploading') {
                                        bar = document.getElementById('progressbar');
                                        w = 400 * upload.received / upload.size;
                                        bar.style.width = w + 'px';
                                        if (upload.stats == 'uploading'){
                                                bar_updated = true;
                                        }
                                }
                                /* we are done, stop the interval */
                                if (upload.state == 'done') {
                                        window.clearTimeout(interval);
                                        if (bar_updated == false){
                                                bar = document.getElementById('progressbar');
                                                bar.style.width = 400 + 'px';
                                        }
                                        sendTitle();
                                }
                        }
                }
        }
        req.send(null);
}
function sendTitle(){
        try{
                req = new XMLHttpRequest();
                title=document.getElementById('title').value;
                alert('title:'+title);
                params = "title="+title;
                req.open("GET", "/send_text?"+params, 0);
                req.setRequestHeader("Content-length", params.length);
                req.setRequestHeader("X-Progress-ID", uuid);
                //req.setRequestHeader("Connection", "close");

                req.send(null);
                document.getElementById('response').innerHTML=req.responseText;

        }catch(e){alert(e);}
}
</script>
</head>

<body>  
<form id="upload" enctype="multipart/form-data" action="/uload" method="post"  target="uploadframe" onsubmit="try{openProgressBar(); return true;}catch(e){alert(e);}">
<input id="title" name="title" type="text" />
<input name="media_file" type="file"/>
<input type="submit" value="Upload"/>
</form>

<iframe id="uploadframe" name="uploadframe" width="0" height="0" frameborder="0" border="0" src="about:blank"></iframe>

<div id="uploading">
<div id="progress" style="width: 400px; border: 1px solid black" >
<div id="progressbar" style="width: 1px; background-color: black; border: 1px solid white">&nbsp;</div>
</div>
</div>
<div id="percents"></div>
<div id="response"></div>
</body>
</html>

